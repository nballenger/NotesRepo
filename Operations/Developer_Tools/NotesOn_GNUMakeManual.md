# Notes on the GNU make Manual

From [https://www.gnu.org/software/make/manual/make.html](https://www.gnu.org/software/make/manual/make.html)

# 1. Overview of `make`

* `make` automatically determines which pieces of a large program need to be recompiled, issues commands to recompile them
* You can use it with any programming language whose compiler can be run with a shell command
* make can actually describe any task where some files must be updated automatically from others whenever the others change

## Preparing and Running Make

* You have to write a `makefile` or `Makefile` that describes relations between files in your program and provides commands for updating each file
* Typically the executable is updated from object files, which in turn are made by compiling source files
* Once a suitable makefile exists, every time you change source files you can just call `make`
* The `make` program uses the makefile database and the last modification times of the files to decide which files need to be updated
* For each file like that, it issues the recipes in the database
* You can provide CLI args to control which files should be recompiled, or how

## 1.1 How to Read this Manual

* In each chapter the first few sections have intro / general info, later sections specialize
* All of chapter 2 is introductory

## 1.2 Problems and Bugs

# 2. An Introduction to Makefiles

* Chapter discusses a simple makefile that describes how to compile and link a text editor consisting of eight C source files and three header files
* Also can tell make how to run misc commands when explicitly asked, for ex as part of clean up
* When `make` recompiles the editor, each changed C source file must be recompiled; if a header file has changed, each C source file that includes the header file must be recompiled to be safe
* Each compilation produces an object file matching the source file
* if any source file has been recompiled then all object files must be linked together to produce the new executable

## 2.1 What a Rule Looks Like

* A simple makefile consists of rules with this shape:

    ```
    target ... : prerequisites ...
        recipe
        ...
        ...
    ```

* `target` - usuallly the name of a file that is generated by a program, like executables are object files, or an action to carry out ('phony' targets)
* `prerequisites` - file used as input to create the target
* `recipe` - action for `make` to carry out
    * a recipe may have more than one command, either on the same line or multiple
    * each line MUST start with a literal tab character
    * If you would rather prefix with a different character, you can set `.RECIPEPREFIX`
* Usually a recipe is a rule with prerequisites and serves to create a target file if any of the prerequisites change. However rules don't require prerequisites.
* A 'rule' then explains how/when to remake certain files which are targets of the rule
* Rules can also explain how/when to carry out an action
* A makefile can have other text in it, but a simple one only needs rules

## 2.2 A Simple Makefile

* File that describes an executable called `edit`, depending on eight object files, which in turn depend on eight C source and three header files
* All the C files include `defs.h`, but only those defining editing commands include `command.h`, and only low level files that deal with the editor buffer include `buffer.h`

    ```
    edit : main.o kbd.o command.o display.o insert.o search.o files.o utils.o
        cc -o edit main.o kbd.o command.o display.o insert.o search.o files.o utils.o

    main.o : main.c defs.h
        cc -c main.c

    kbd.o : kbd.c defs.h command.h
        cc -c kbd.c

    [...]

    clean :
        rm edit main.o kbd.o command.o display.o insert.o search.o files.o utils.o
    ```

* Each .o file is both a target and a prerequisite
* When a target is a file, it needs to be recompiled or relinked if any of its prereqs change
* Additionally, any prereqs that are themselves auto generated should be updated first
* A recipe may follow each line that contains a target and prereqs
* The recipes say how to update the target file
* Since clean is not a file and is not a prereq of any other rule, make never does anything with it unless you tell it to
* Targets that don't refer to files but are just actions are 'phony targets'

## 2.3 How `make` processes a Makefile

* By default `make` starts with the first target (not targets whose name starts with `.`)
* This is the 'default goal'
* You can override that from the command line, or with the `.DEFAULT_GOAL` special variable

## 2.4 Variables Make Makefiles Simpler

* Had to list all the object files twice in the `edit` rule above
* Variables let you define a text string and sub it in later
* It's standard practice for every makefile to have a variable named one of
    * `objects`
    * `OBJECTS`
    * `objs`
    * `OBJS`
    * `obj`
    * `OBJ`
* That var will be a list of all object file names
* Defined like this:

    ```
    objects = main.o kbd.o command.o display.o insert.o search.o files.o utils.o
    ```

* Where you want to use it, you do `$(objects)`

## 2.5 Letting `make` Deduce the Recipes

* 
